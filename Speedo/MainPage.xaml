<phone:PhoneApplicationPage x:Class="Speedo.MainPage"
                            xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                            xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                            xmlns:phone="clr-namespace:Microsoft.Phone.Controls;assembly=Microsoft.Phone"
                            xmlns:shell="clr-namespace:Microsoft.Phone.Shell;assembly=Microsoft.Phone"
                            xmlns:bar="clr-namespace:BindableApplicationBar;assembly=BindableApplicationBar"
                            xmlns:my="clr-namespace:Speedo.Controls"
                            xmlns:maps="clr-namespace:Microsoft.Phone.Maps.Controls;assembly=Microsoft.Phone.Maps"
                            xmlns:tool="clr-namespace:Microsoft.Phone.Controls;assembly=Microsoft.Phone.Controls.Toolkit" 
                            FontFamily="{StaticResource PhoneFontFamilyNormal}"
                            FontSize="{StaticResource PhoneFontSizeNormal}"
                            Foreground="{StaticResource PhoneForegroundBrush}"
                            SupportedOrientations="PortraitOrLandscape"
                            Orientation="Portrait"
                            shell:SystemTray.IsVisible="True">
    <shell:SystemTray.ProgressIndicator>
        <shell:ProgressIndicator IsIndeterminate="True" 
                                 IsVisible="{Binding IsLocating}" 
                                 Text="Locating..." />
    </shell:SystemTray.ProgressIndicator>
    <Grid>
        <Grid x:Name="LayoutRoot" 
              Background="{StaticResource PhoneBackgroundBrush}" 
              MouseLeftButtonDown="LayoutRoot_MouseLeftButtonDown">

            <Grid x:Name="MapLayer"
                  Background="#CCCCCC">
                <!-- TODO: LoadingError isn't supported any more, fix it? -->
                <maps:Map x:Name="BackMap" 
                          IsHitTestVisible="False" 
                          Visibility="Visible" 
                          VerticalAlignment="Center" 
                          HorizontalAlignment="Center" 
                          RenderTransformOrigin="0.5,0.5" 
                          Width="934" 
                          Height="934" 
                          CartographicMode="Road"                         
                          CacheMode="BitmapCache">                   
                    <maps:Map.RenderTransform>
                        <RotateTransform x:Name="BackMapRotateTransform" Angle="0" />
                    </maps:Map.RenderTransform>
                </maps:Map>
                <Rectangle Fill="{StaticResource PhoneBackgroundBrush}" 
                           Opacity="0.65" />
            </Grid>

            <Grid VerticalAlignment="Center" 
                  Margin="0,-70,0,0" 
                  RenderTransformOrigin="0.5,0.5">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <Grid Margin="10,0,10,0" 
                      Height="300">
                    <TextBlock x:Name="StatusTextBlock" 
                               HorizontalAlignment="Center" 
                               VerticalAlignment="Top" 
                               Margin="0,0,0,20" 
                               Text="Status" />
                    <TextBlock x:Name="SpeedTextBlock" 
                               FontSize="260" 
                               LineHeight="240" 
                               LineStackingStrategy="BlockLineHeight" 
                               Margin="0,30,0,0" 
                               FontFamily="Segoe WP SemiLight" 
                               HorizontalAlignment="Center" 
                               VerticalAlignment="Center" Text="0" />
                    <TextBlock x:Name="UnitTextBlock" 
                               HorizontalAlignment="Center" 
                               VerticalAlignment="Bottom" 
                               Margin="0,0,0,14" 
                               Style="{StaticResource PhoneTextSmallStyle}" 
                               Text="km/h" />
                </Grid>

                <Grid Margin="10,0,10,0" 
                      Grid.Row="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="30" />
                        <RowDefinition Height="64" />
                    </Grid.RowDefinitions>
                    
                    <my:SpeedGraph Source="{Binding SpeedSource}"
                                   PointsCount="360"
                                   Height="30"
                                   Visibility="{Binding ShowSpeedGraph, Converter={StaticResource BoolToVisibility}}" />

                    <my:DirectionDisplay Grid.Row="1"
                                         AllowLocationAccess="{Binding AllowLocationAccess}"
                                         HorizontalAlignment="Center" />
                </Grid>
                <Grid.RenderTransform>
                    <ScaleTransform x:Name="ContentScaleTransform" />
                </Grid.RenderTransform>
            </Grid>

            <Grid x:Name="settingsGrid" 
                  Margin="0,0,0,0">
                <Grid x:Name="windscreenRoot" 
                      HorizontalAlignment="Left" 
                      VerticalAlignment="Top">
                    <my:BubbleButton x:Name="windscreenButton" 
                                     MouseLeftButtonDown="WindscreenButton_MouseLeftButtonDown" 
                                     Style="{StaticResource RoundIconButton}" 
                                     tool:TiltEffect.IsTiltEnabled="True">
                        <ImageBrush ImageSource="Resources/windscreen.png" />
                    </my:BubbleButton>
                    <Grid x:Name="windsreenIndicator" 
                          Visibility="Collapsed" 
                          IsHitTestVisible="False" 
                          Background="{StaticResource PhoneAccentBrush}" 
                          Width="48" Height="48" 
                          Margin="16">
                        <Grid.OpacityMask>
                            <ImageBrush ImageSource="Resources/windscreen.png"/>
                        </Grid.OpacityMask>
                    </Grid>
                    <Grid.RenderTransform>
                        <TransformGroup>
                            <ScaleTransform/>
                            <SkewTransform/>
                            <RotateTransform/>
                            <TranslateTransform/>
                        </TransformGroup>
                    </Grid.RenderTransform>
                </Grid>
                <Grid x:Name="mapRoot" 
                      HorizontalAlignment="Right" 
                      VerticalAlignment="Top">
                    <my:BubbleButton x:Name="mapButton" 
                                     MouseLeftButtonDown="MapButton_MouseLeftButtonDown" 
                                     Style="{StaticResource RoundIconButton}" 
                                     tool:TiltEffect.IsTiltEnabled="True">
                        <ImageBrush ImageSource="Resources/map.png" />
                    </my:BubbleButton>
                    <Grid.RenderTransform>
                        <TransformGroup>
                            <ScaleTransform/>
                            <SkewTransform/>
                            <RotateTransform/>
                            <TranslateTransform/>
                        </TransformGroup>
                    </Grid.RenderTransform>
                </Grid>
                <Grid x:Name="alertRoot" 
                      HorizontalAlignment="Left" 
                      VerticalAlignment="Bottom">
                    <my:BubbleButton x:Name="alertButton" 
                                     MouseLeftButtonDown="AlertButton_MouseLeftButtonDown" 
                                     Style="{StaticResource RoundIconButton}" 
                                     tool:TiltEffect.IsTiltEnabled="True">
                        <ImageBrush ImageSource="Resources/alert.png" />
                    </my:BubbleButton>
                    <Grid x:Name="alertIndicator" 
                          Visibility="Collapsed" 
                          IsHitTestVisible="False" 
                          Background="{StaticResource PhoneAccentBrush}" 
                          Width="48" Height="48" 
                          Margin="16">
                        <Grid.OpacityMask>
                            <ImageBrush ImageSource="Resources/alert.png"/>
                        </Grid.OpacityMask>
                    </Grid>
                    <Grid.RenderTransform>
                        <TransformGroup>
                            <ScaleTransform/>
                            <SkewTransform/>
                            <RotateTransform/>
                            <TranslateTransform/>
                        </TransformGroup>
                    </Grid.RenderTransform>
                </Grid>
                <StackPanel HorizontalAlignment="Center" 
                            VerticalAlignment="Bottom" 
                            Margin="0,15">
                    <TextBlock x:Name="DistanceTextBlock" 
                               HorizontalAlignment="Center" />
                    <TextBlock HorizontalAlignment="Center" 
                               Style="{StaticResource PhoneTextSmallStyle}"
                               Text="distance" />
                </StackPanel>
                <Grid Margin="0,36,0,0" 
                      VerticalAlignment="Center">
                    <StackPanel HorizontalAlignment="Left">
                        <TextBlock x:Name="AvgSpeedTextBlock" 
                                   Margin="12,0" 
                                   FontSize="30"
                                   Text="0" />
                        <TextBlock Style="{StaticResource PhoneTextSmallStyle}"
                                   Text="average" />
                    </StackPanel>
                    <StackPanel HorizontalAlignment="Right">
                        <TextBlock x:Name="MaxSpeedTextBlock" 
                                   HorizontalAlignment="Right" 
                                   Margin="12,0" 
                                   FontSize="30"
                                   Text="0" />
                        <TextBlock HorizontalAlignment="Right" 
                                   Style="{StaticResource PhoneTextSmallStyle}"
                                   Text="max" />
                    </StackPanel>
                </Grid>
            </Grid>

            <tool:GestureService.GestureListener>
                <tool:GestureListener PinchStarted="GestureListener_PinchStarted" 
                                   PinchDelta="GestureListener_PinchDelta" 
                                         PinchCompleted="GestureListener_PinchCompleted" />
            </tool:GestureService.GestureListener>
        </Grid>

        <Grid x:Name="PopupHost">
            <Grid x:Name="PopupContent" />
            <Grid.Projection>
                <PlaneProjection CenterOfRotationY="0.5" RotationX="0"></PlaneProjection>
            </Grid.Projection>
        </Grid>

        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup x:Name="CustomStates">
                <VisualState x:Name="HideControls">
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetName="windscreenButton" 
                                         Storyboard.TargetProperty="Opacity" 
                                         To="0" 
                                         Duration="0:0:0.2" />
                        <DoubleAnimation Storyboard.TargetName="mapButton" 
                                         Storyboard.TargetProperty="Opacity" 
                                         To="0" 
                                         Duration="0:0:0.2" />
                        <DoubleAnimation Storyboard.TargetName="alertButton" 
                                         Storyboard.TargetProperty="Opacity" 
                                         To="0" 
                                         Duration="0:0:0.2" />
                    </Storyboard>
                </VisualState>
                <VisualState x:Name="ShowControls">
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetName="windscreenButton" 
                                         Storyboard.TargetProperty="Opacity" 
                                         To="1" 
                                         Duration="0:0:0.2" />
                        <DoubleAnimation Storyboard.TargetName="mapButton" 
                                         Storyboard.TargetProperty="Opacity" 
                                         To="1" 
                                         Duration="0:0:0.2" />
                        <DoubleAnimation Storyboard.TargetName="alertButton" 
                                         Storyboard.TargetProperty="Opacity" 
                                         To="1" 
                                         Duration="0:0:0.2" />
                    </Storyboard>
                </VisualState>
            </VisualStateGroup>

            <VisualStateGroup x:Name="OrientationStates">
                <VisualState x:Name="PortraitUp" />
                <VisualState x:Name="LandscapeRight">
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetName="alertRoot" 
                                         Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[3].(TranslateTransform.X)" 
                                         To="80" 
                                         Duration="0" />
                        <DoubleAnimation Storyboard.TargetName="windscreenRoot" 
                                         Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[3].(TranslateTransform.X)" 
                                         To="80" 
                                         Duration="0" />
                    </Storyboard>
                </VisualState>
                <VisualState x:Name="LandscapeLeft">
                    <Storyboard>
                        <DoubleAnimation Storyboard.TargetName="mapRoot" 
                                         Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[3].(TranslateTransform.X)" 
                                         To="-80" 
                                         Duration="0" />
                    </Storyboard>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <tool:TransitionService.NavigationInTransition>
            <tool:NavigationInTransition>
                <tool:NavigationInTransition.Backward>
                    <tool:TurnstileTransition Mode="BackwardIn"/>
                </tool:NavigationInTransition.Backward>
                <tool:NavigationInTransition.Forward>
                    <tool:TurnstileTransition Mode="ForwardIn"/>
                </tool:NavigationInTransition.Forward>
            </tool:NavigationInTransition>
        </tool:TransitionService.NavigationInTransition>
        <tool:TransitionService.NavigationOutTransition>
            <tool:NavigationOutTransition>
                <tool:NavigationOutTransition.Backward>
                    <tool:TurnstileTransition Mode="BackwardOut"/>
                </tool:NavigationOutTransition.Backward>
                <tool:NavigationOutTransition.Forward>
                    <tool:TurnstileTransition Mode="ForwardOut"/>
                </tool:NavigationOutTransition.Forward>
            </tool:NavigationOutTransition>
        </tool:TransitionService.NavigationOutTransition>
    </Grid>

    <bar:Bindable.ApplicationBar>
        <bar:BindableApplicationBar IsVisible="True"
                                    IsMenuEnabled="True"
                                    Mode="Minimized"
                                    Opacity="{Binding IsMenuVisible, RelativeSource={RelativeSource Self}, 
                                                      Converter={StaticResource BoolToAppBarOpacity}}">
            <bar:BindableApplicationBar.MenuItems>
                <bar:BindableApplicationBarMenuItem Text="{Binding SwitchUnitsText}"
                                                    Command="{Binding SwitchUnitsCommand}" />
                <bar:BindableApplicationBarMenuItem Text="{Binding SwitchLocationAccessText}" 
                                                    Command="{Binding SwitchLocationAccessCommand}" />
                <bar:BindableApplicationBarMenuItem Text="about" 
                                                    Command="{Binding AboutCommand}" />
            </bar:BindableApplicationBar.MenuItems>

        </bar:BindableApplicationBar>
    </bar:Bindable.ApplicationBar>
    
    <!--<phone:PhoneApplicationPage.ApplicationBar>
        <shell:ApplicationBar IsVisible="True" 
                              IsMenuEnabled="True" 
                              Mode="Minimized" 
                              StateChanged="ApplicationBar_StateChanged" 
                              Opacity="0">
            <shell:ApplicationBar.MenuItems>
                <shell:ApplicationBarMenuItem x:Name="SwitchMetric" 
                                              Text="switch to metric (km/h)" 
                                              Click="SwitchMetric_Click" />
                <shell:ApplicationBarMenuItem x:Name="DisableLocation" 
                                              Text="disable location access" 
                                              Click="DisableLocation_Click" />
                <shell:ApplicationBarMenuItem x:Name="About" 
                                              Text="about" 
                                              Click="About_Click" />
            </shell:ApplicationBar.MenuItems>
        </shell:ApplicationBar>
    </phone:PhoneApplicationPage.ApplicationBar>-->
</phone:PhoneApplicationPage>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       